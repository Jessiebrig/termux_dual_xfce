#!/bin/bash

#==============================================================================
# Color Codes
#==============================================================================
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

#==============================================================================
# Logging Setup
#==============================================================================
LOG_FILE="$HOME/xfce_gpu.log"

log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $*"
    echo "$msg" >> "$LOG_FILE"
}

SCRIPT_PATH="${BASH_SOURCE[0]}"
if [[ -f "$SCRIPT_PATH" ]]; then
    XRUN_DATE=$(ls -l "$SCRIPT_PATH" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "$SCRIPT_PATH" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "$SCRIPT_PATH" 2>/dev/null || date -r "$SCRIPT_PATH" '+%b %d %H:%M' 2>/dev/null || echo "Unknown")
    echo "File date: ${XRUN_DATE}"
    echo ""
fi

#==============================================================================
# GPU Configuration Functions - Termux Layer
#==============================================================================

prompt_termux_gpu() {
    local egl=$(getprop ro.hardware.egl)
    local vulkan=$(getprop ro.hardware.vulkan)
    if [[ "$egl" == "$vulkan" ]]; then
        local gpu_info="$egl"
    else
        local gpu_info="$egl / $vulkan"
    fi
    echo -e "${GREEN}[Termux XFCE]${NC} GPU: $gpu_info" | tee -a ~/xfce_gpu.log > /dev/tty
    echo "" > /dev/tty
    echo "Select GPU acceleration mode:" > /dev/tty
    echo "  0) Software rendering (no GPU)" > /dev/tty
    echo "  1) Auto-detect (recommended)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Direct GPU (Adreno 6XX/7XX only) ---" > /dev/tty
    echo "  2) Turnip Basic (direct Vulkan)" > /dev/tty
    echo "  3) Turnip Optimized (+ threading, descriptor caching)" > /dev/tty
    echo "  4) Turnip Aggressive (experimental, best for gaming)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Universal (works on all GPUs) ---" > /dev/tty
    echo "  5) VIRGL Basic (OpenGL via server, safe)" > /dev/tty
    echo "  6) VIRGL Optimized (+ threading, Mali recommended)" > /dev/tty
    echo "  7) ZINK Basic (Vulkan via server)" > /dev/tty
    echo "  8) ZINK Optimized (+ threading, descriptor caching)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Advanced ---" > /dev/tty
    echo "  9) Custom (enter your own commands)" > /dev/tty
    echo "  10) Test Mode (auto-setup: ZINK server + VIRGL proot)" > /dev/tty
    echo "" > /dev/tty
    echo -n "Choice [0-10]: " > /dev/tty
    read -r gpu_choice < /dev/tty
    gpu_choice=$(echo "$gpu_choice" | tr -cd '0-9')
    [[ -z "$gpu_choice" ]] && gpu_choice="0"
    echo "$gpu_choice"
}

apply_termux_gpu() {
    local gpu_choice="$1"
    local launch_xfce="${2:-true}"
    local gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    
    log "apply_termux_gpu: gpu_choice='$gpu_choice', launch_xfce='$launch_xfce'"
    
    if [[ "$gpu_choice" == "0" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Software rendering mode (No acceleration)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE in software rendering mode"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Software rendering: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "1" ]]; then
        local egl=$(getprop ro.hardware.egl)
        local vulkan=$(getprop ro.hardware.vulkan)
        local renderer=$(getprop ro.hardware.renderer 2>/dev/null || echo "unknown")
        
        echo "" | tee -a ~/xfce_gpu.log
        echo -e "${CYAN}=== Auto-detect GPU ===${NC}" | tee -a ~/xfce_gpu.log
        echo "EGL: $egl" | tee -a ~/xfce_gpu.log
        echo "Vulkan: $vulkan" | tee -a ~/xfce_gpu.log
        echo "Renderer: $renderer" | tee -a ~/xfce_gpu.log
        echo "" | tee -a ~/xfce_gpu.log
        
        if echo "$egl $vulkan" | grep -iq "adreno"; then
            echo -e "${GREEN}✓ Adreno GPU detected → Using Turnip Aggressive (Option 4)${NC}" | tee -a ~/xfce_gpu.log
            log "Auto-detect: Adreno detected, redirecting to option 4"
            apply_termux_gpu "4" "$launch_xfce"
            return
        elif echo "$egl $vulkan" | grep -iq "mali"; then
            echo -e "${GREEN}✓ Mali GPU detected → Using VIRGL Optimized (Option 6)${NC}" | tee -a ~/xfce_gpu.log
            log "Auto-detect: Mali detected, redirecting to option 6"
            apply_termux_gpu "6" "$launch_xfce"
            return
        else
            echo -e "${YELLOW}⚠ Unknown GPU → Using VIRGL Basic (Option 5, safe fallback)${NC}" | tee -a ~/xfce_gpu.log
            log "Auto-detect: Unknown GPU, redirecting to option 5"
            apply_termux_gpu "5" "$launch_xfce"
            return
        fi
    elif [[ "$gpu_choice" == "2" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Basic (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Basic"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Turnip Basic: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "3" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Optimized (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Optimized"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Turnip Optimized: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "4" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Aggressive (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Aggressive"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,sysmem ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Turnip Aggressive: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "5" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL Basic (universal)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting VIRGL server (Mali GPU with ANGLE)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        else
            log "Starting VIRGL server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL Basic"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "6" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL Optimized (universal)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting VIRGL Optimized server (Mali GPU with ANGLE)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android --angle-gl &
        else
            log "Starting VIRGL Optimized server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL Optimized"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "7" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK Basic (universal)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting ZINK Basic server (Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink virgl_test_server --use-egl-surfaceless --use-gles &
        else
            log "Starting ZINK Basic server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with ZINK Basic"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "8" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK Optimized (universal)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting ZINK Optimized server (Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server --use-egl-surfaceless --use-gles &
        else
            log "Starting ZINK Optimized server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with ZINK Optimized"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "9" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Custom Mode (Advanced)" | tee -a ~/xfce_gpu.log
        log "Custom mode selected"
        
        echo -n "Start a server? (y/n): " > /dev/tty
        read -r need_server < /dev/tty
        
        if [[ "$need_server" =~ ^[Yy]$ ]]; then
            echo "Enter server command:" > /dev/tty
            echo "Example: GALLIUM_DRIVER=zink virgl_test_server_android" > /dev/tty
            echo -n "> " > /dev/tty
            read -r server_cmd < /dev/tty
            
            if [[ -n "$server_cmd" ]]; then
                log "Custom server: $server_cmd"
                eval "$server_cmd &"
                sleep 2
            fi
        fi
        
        if [[ "$launch_xfce" == "true" ]]; then
            echo "Enter environment variables for XFCE:" > /dev/tty
            echo "Example: GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0" > /dev/tty
            echo -n "> " > /dev/tty
            read -r custom_env < /dev/tty
            
            log "Custom env: $custom_env"
            
            if [[ -n "$custom_env" ]]; then
                dbus-launch --exit-with-session env $custom_env xfce4-session &
            else
                dbus-launch --exit-with-session xfce4-session &
            fi
        fi
    elif [[ "$gpu_choice" == "10" ]]; then
        echo -e "${CYAN}[Termux XFCE]${NC} Test Mode (ZINK server for proot testing)" | tee -a ~/xfce_gpu.log
        log "Test Mode: Starting ZINK EGL server for proot"
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Test Mode: Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Test Mode: Server-only mode for proot"
        fi
    else
        echo -e "${YELLOW}[Termux XFCE]${NC} Invalid choice, using software rendering" | tee -a ~/xfce_gpu.log
        log "Invalid gpu_choice='$gpu_choice', using software rendering"
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE in software rendering mode"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Software rendering: Skipping XFCE launch"
        fi
    fi
}

#==============================================================================
# GPU Configuration Functions - Proot Layer
#==============================================================================

prompt_proot_driver() {
    echo "" > /dev/tty
    echo -e "${CYAN}[Debian Proot]${NC} Select GPU driver:" > /dev/tty
    echo "  0) Software rendering (no GPU)" > /dev/tty
    echo "  1) Auto-detect (recommended)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Direct GPU (Adreno 6XX/7XX only) ---" > /dev/tty
    echo "  2) Turnip Basic (direct Vulkan)" > /dev/tty
    echo "  3) Turnip Optimized (+ threading, descriptor caching)" > /dev/tty
    echo "  4) Turnip Aggressive (+ sysmem, vsync off, best for gaming)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Universal (works on all GPUs) ---" > /dev/tty
    echo "  5) VIRGL Basic (OpenGL via server, safe)" > /dev/tty
    echo "  6) VIRGL Optimized (+ threading, Mali recommended)" > /dev/tty
    echo "  7) ZINK Basic (Vulkan via server)" > /dev/tty
    echo "  8) ZINK Optimized (+ threading, descriptor caching)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Advanced ---" > /dev/tty
    echo "  9) Custom (enter your own environment variables)" > /dev/tty
    echo "" > /dev/tty
    echo -n "Choice [0-9]: " > /dev/tty
    read -r driver_choice < /dev/tty
    driver_choice=$(echo "$driver_choice" | tr -cd '0-9')
    [[ -z "$driver_choice" ]] && driver_choice="0"
    echo "$driver_choice"
}

apply_proot_driver() {
    local driver_choice="$1"
    local username="$2"
    
    log "apply_proot_driver: driver_choice='$driver_choice', username='$username'"
    
    if [[ "$driver_choice" == "0" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Software rendering mode" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE in software rendering mode"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "1" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Auto-detect mode (should not reach here)" | tee -a ~/xfce_gpu.log
        log "Proot: Auto-detect fallback to VIRGL Basic"
        apply_proot_driver "5" "$username"
    elif [[ "$driver_choice" == "2" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip Basic (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with Turnip Basic"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "3" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip Optimized (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with Turnip Optimized"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "4" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip Aggressive (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with Turnip Aggressive"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,sysmem ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "5" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL Basic" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VIRGL Basic"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "6" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL Optimized" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VIRGL Optimized"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "7" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK Basic" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with ZINK Basic"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "8" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK Optimized" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with ZINK Optimized"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "9" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Custom Mode (Advanced)" | tee -a ~/xfce_gpu.log
        log "Proot: Custom mode selected"
        
        echo "Enter environment variables for Debian XFCE:" > /dev/tty
        echo "Example: GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0" > /dev/tty
        echo -n "> " > /dev/tty
        read -r custom_env < /dev/tty
        
        log "Proot custom env: $custom_env"
        
        if [[ -n "$custom_env" ]]; then
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 $custom_env dbus-launch --exit-with-session xfce4-session
        else
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
        fi
    else
        echo -e "${YELLOW}[Debian XFCE]${NC} Invalid choice, using software rendering" | tee -a ~/xfce_gpu.log
        log "Proot: Invalid driver_choice='$driver_choice', using software rendering"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    fi
}

#==============================================================================
# Desktop Environment Launchers
#==============================================================================

start_xfce() {
    log "start_xfce: Starting Native Termux XFCE"
    gpu_choice=$(prompt_termux_gpu)
    log "start_xfce: User selected GPU mode $gpu_choice"
    
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        log "start_xfce: Samsung device detected, using libskcodec.so"
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        log "start_xfce: Starting pulseaudio"
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0
    mkdir -p "$XDG_RUNTIME_DIR"

    log "start_xfce: Starting Termux-X11 server"
    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1
    
    apply_termux_gpu "$gpu_choice" "true"
}

start_debian_xfce() {
    log "start_debian_xfce: Starting Debian XFCE"
    echo -e "${GREEN}[Debian XFCE]${NC} GPU: $(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)" | tee -a ~/xfce_gpu.log
    echo ""
    echo "Step 1: Termux GPU (server)"
    termux_gpu_choice=$(prompt_termux_gpu)
    log "start_debian_xfce: Termux GPU choice=$termux_gpu_choice"
    
    username=$(get_debian_username)
    log "start_debian_xfce: Debian username=$username"
    
    # Auto-detect proot driver based on Termux choice
    if [[ "$termux_gpu_choice" == "1" ]]; then
        # Termux Auto was selected, auto-select proot driver
        echo ""
        echo -e "${CYAN}Step 2: Proot GPU (driver) - Auto-selected${NC}"
        
        local egl=$(getprop ro.hardware.egl)
        local vulkan=$(getprop ro.hardware.vulkan)
        
        if echo "$egl $vulkan" | grep -iq "adreno"; then
            proot_driver_choice="6"  # VIRGL Optimized (Turnip in Termux acts as GPU)
            echo -e "${GREEN}✓ Adreno detected → Termux using Turnip, Proot using VIRGL Optimized (Option 6)${NC}" | tee -a ~/xfce_gpu.log
            log "Proot auto-detect: Adreno, Termux has Turnip, using VIRGL Optimized (6)"
        elif echo "$egl $vulkan" | grep -iq "mali"; then
            proot_driver_choice="6"  # VIRGL Optimized
            echo -e "${GREEN}✓ Mali detected → Using VIRGL Optimized (Option 6)${NC}" | tee -a ~/xfce_gpu.log
            log "Proot auto-detect: Mali, using VIRGL Optimized (6)"
        else
            proot_driver_choice="5"  # VIRGL Basic
            echo -e "${YELLOW}⚠ Unknown GPU → Using VIRGL Basic (Option 5)${NC}" | tee -a ~/xfce_gpu.log
            log "Proot auto-detect: Unknown GPU, using VIRGL Basic (5)"
        fi
    elif [[ "$termux_gpu_choice" == "0" ]]; then
        # Software rendering
        echo ""
        echo -e "${CYAN}Step 2: Proot GPU (driver) - Auto-selected${NC}"
        proot_driver_choice="0"  # Software
        echo -e "${YELLOW}✓ Termux software rendering → Proot software rendering${NC}" | tee -a ~/xfce_gpu.log
        log "Proot auto-match: Software rendering (0)"
    elif [[ "$termux_gpu_choice" == "10" ]]; then
        # Test Mode - auto-select VIRGL Basic for proot
        echo ""
        echo -e "${CYAN}Step 2: Proot GPU (driver) - Auto-selected${NC}"
        proot_driver_choice="5"  # VIRGL Basic
        echo -e "${GREEN}✓ Test Mode → Proot using VIRGL Basic (Option 5)${NC}" | tee -a ~/xfce_gpu.log
        log "Proot auto-match: Test Mode, using VIRGL Basic (5)"
    else
        # Manual selection (2-9), show prompt
        echo ""
        echo "Step 2: Proot GPU (driver)"
        proot_driver_choice=$(prompt_proot_driver)
        log "start_debian_xfce: Proot driver choice=$proot_driver_choice (manual)"
    fi
    
    if ! pgrep -f "termux-x11" > /dev/null; then
        log "start_debian_xfce: Termux-X11 not running, starting..."
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            log "start_debian_xfce: Samsung device detected"
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    else
        log "start_debian_xfce: Termux-X11 already running"
    fi
    
    log "Debian XFCE: Starting GPU server (server-only mode)"
    apply_termux_gpu "$termux_gpu_choice" "false"
    log "GPU server started, waiting before launching proot"
    sleep 2
    
    log "Debian XFCE: Launching proot with driver choice=$proot_driver_choice"
    apply_proot_driver "$proot_driver_choice" "$username"
}

#==============================================================================
# Helper Functions
#==============================================================================

get_debian_username() {
    basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*
}

get_file_date() {
    if [[ -f "${BASH_SOURCE[0]}" ]]; then
        ls -l "${BASH_SOURCE[0]}" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "${BASH_SOURCE[0]}" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "${BASH_SOURCE[0]}" 2>/dev/null || date -r "${BASH_SOURCE[0]}" '+%b %d %H:%M' 2>/dev/null || echo "Unknown"
    elif [[ -f "xrun" ]]; then
        ls -l "xrun" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "xrun" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "xrun" 2>/dev/null || date -r "xrun" '+%b %d %H:%M' 2>/dev/null || echo "Unknown"
    else
        echo "Unknown"
    fi
}

show_help() {
    if [[ -n "$1" ]]; then
        echo "Unknown command: $1"
        echo ""
    fi
    echo "Available commands:"
    echo "  xrun                  - Show interactive menu"
    echo "  xrun xfce             - Launch native Termux XFCE"
    echo "  xrun debian_xfce      - Launch Debian XFCE"
    echo "  xrun debian           - Enter Debian proot CLI"
    echo "  xrun drun <command>   - Run Debian commands"
    echo "  xrun dgpu <command>   - Run with hardware acceleration"
    echo "  xrun dfps <command>   - Run with HW accel + FPS display"
    echo "  xrun kill_termux_x11  - Kill Termux-X11"
    echo "  xrun update           - Run initializer to update scripts"
    echo "  xrun help             - Show this help message"
}

#==============================================================================
# Debian Proot Utilities
#==============================================================================

start_debian() {
    log "start_debian: Entering Debian proot CLI"
    username=$(get_debian_username)
    export DISPLAY=:0
    proot-distro login debian --user $username --shared-tmp
}

drun() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 "$@"
}

dgpu() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform "$@"
}

dfps() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform GALLIUM_HUD=fps "$@"
}

#==============================================================================
# System Utilities
#==============================================================================

kill_termux_x11() {
    log "kill_termux_x11: Stopping Termux-X11"
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
    log "kill_termux_x11: Termux-X11 stopped"
}

run_initializer() {
    log "run_initializer: Launching initializer"
    local tmp="${TMPDIR:-/tmp}/init_$$.sh"
    echo ""
    echo -e "${GREEN}Downloading initializer...${NC}"
    
    if curl -sL https://raw.githubusercontent.com/Jessiebrig/termux_dual_xfce/main/initialize.sh -o "$tmp"; then
        chmod +x "$tmp"
        exec bash "$tmp"
    else
        echo -e "${YELLOW}Failed to download initializer.${NC}"
        echo -n "Press Enter to continue..." > /dev/tty
        read < /dev/tty
        return 1
    fi
}

#==============================================================================
# Interactive Menu
#==============================================================================

show_menu() {
    while true; do
        clear
        echo "File date: $(get_file_date)"
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian CLI"
        echo "      Enter Debian proot terminal"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - drun <command>"
        echo "      Run Debian commands from Termux"
        echo ""
        echo -e "  ${GREEN}5${NC} - dgpu <command>"
        echo "      Run with hardware acceleration"
        echo ""
        echo -e "  ${GREEN}6${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "${CYAN}Setup:${NC}"
        echo -e "  ${GREEN}9${NC} - Check for Updates"
        echo "      Download xrun and main script from your selected branch"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-9]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    drun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    dgpu $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            6)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            9)
                run_initializer
                ;;
            0)
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

#==============================================================================
# Main Entry Point
#==============================================================================

if [[ $# -eq 0 ]]; then
    show_menu
else
    case "$1" in
        xfce)
            start_xfce
            ;;
        debian_xfce)
            start_debian_xfce
            ;;
        debian)
            start_debian
            ;;
        drun)
            shift
            drun "$@"
            ;;
        dgpu)
            shift
            dgpu "$@"
            ;;
        dfps)
            shift
            dfps "$@"
            ;;
        kill_termux_x11)
            kill_termux_x11
            ;;
        update)
            run_initializer
            ;;
        help)
            show_help ""
            ;;
        *)
            show_help "$1"
            exit 1
            ;;
    esac
fi
