#!/bin/bash

# Color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function: Start native Termux XFCE
start_xfce() {
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    # Setup audio (experimental: Samsung-specific fix, may work for other devices)
    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0

    # Ensure D-Bus directories exist
    mkdir -p "$XDG_RUNTIME_DIR"

    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1

    # GPU detection
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    if echo "$gpu_info" | grep -iq "adreno"; then
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
    elif echo "$gpu_info" | grep -iq "mali"; then
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
    fi

    dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe xfce4-session &
}

# Function: Start Debian XFCE
start_debian_xfce() {
    # Start Termux X11 if not already running
    if ! pgrep -f "termux-x11" > /dev/null; then
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        # Setup audio (experimental: Samsung-specific fix, may work for other devices)
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    fi

    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
}

# Function: Enter Debian proot CLI
start_debian() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp
}

# Function: Run Debian commands
prun() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 "$@"
}

# Function: Run with hardware acceleration
zrun() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform "$@"
}

# Function: Run with hardware acceleration + FPS display
zrunhud() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform GALLIUM_HUD=fps "$@"
}

# Function: Kill Termux-X11
kill_termux_x11() {
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
}

# Function: Copy Debian apps to menu
cp2menu() {
    debian_apps="$PREFIX/var/lib/proot-distro/installed-rootfs/debian/usr/share/applications"
    termux_apps="$PREFIX/share/applications"

    if [[ ! -d "$debian_apps" ]]; then
        echo "Error: Debian applications directory not found"
        exit 1
    fi

    echo "Available Debian applications:"
    ls "$debian_apps"/*.desktop 2>/dev/null | nl

    echo -n "Enter number to copy (or 'all' for all): " > /dev/tty
    read choice < /dev/tty

    if [[ "$choice" == "all" ]]; then
        cp "$debian_apps"/*.desktop "$termux_apps/"
        echo "All applications copied"
    else
        file=$(ls "$debian_apps"/*.desktop 2>/dev/null | sed -n "${choice}p")
        if [[ -f "$file" ]]; then
            cp "$file" "$termux_apps/"
            echo "Copied: $(basename "$file")"
        else
            echo "Invalid selection"
        fi
    fi
}

# Function: Show interactive menu
show_menu() {
    while true; do
        clear
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian CLI"
        echo "      Enter Debian proot terminal"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - prun <command>"
        echo "      Run Debian commands from Termux"
        echo ""
        echo -e "  ${GREEN}5${NC} - zrun <command>"
        echo "      Run with hardware acceleration"
        echo ""
        echo -e "  ${GREEN}6${NC} - zrunhud <command>"
        echo "      Run with HW accel + FPS display"
        echo ""
        echo -e "  ${GREEN}7${NC} - cp2menu"
        echo "      Copy Debian apps to Termux menu"
        echo ""
        echo -e "  ${GREEN}8${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-8]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    prun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    zrun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            6)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    zrunhud $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            7)
                echo ""
                cp2menu
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            8)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            0)
                echo ""
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

# Main logic
if [[ $# -eq 0 ]]; then
    # No arguments - show interactive menu
    show_menu
else
    # Arguments provided - run the function
    case "$1" in
        start_xfce)
            start_xfce
            clear
            ;;
        start_debian_xfce)
            start_debian_xfce
            clear
            ;;
        start_debian)
            start_debian
            clear
            ;;
        prun)
            shift
            prun "$@"
            clear
            ;;
        zrun)
            shift
            zrun "$@"
            clear
            ;;
        zrunhud)
            shift
            zrunhud "$@"
            clear
            ;;
        kill_termux_x11)
            kill_termux_x11
            clear
            ;;
        cp2menu)
            cp2menu
            clear
            ;;
        *)
            echo "Unknown command: $1"
            echo ""
            echo "Available commands:"
            echo "  xrun                  - Show interactive menu"
            echo "  xrun start_xfce       - Launch native Termux XFCE"
            echo "  xrun start_debian_xfce - Launch Debian XFCE"
            echo "  xrun start_debian     - Enter Debian proot CLI"
            echo "  xrun prun <command>   - Run Debian commands"
            echo "  xrun zrun <command>   - Run with hardware acceleration"
            echo "  xrun zrunhud <command> - Run with HW accel + FPS display"
            echo "  xrun cp2menu          - Copy Debian apps to menu"
            echo "  xrun kill_termux_x11  - Kill Termux-X11"
            exit 1
            ;;
    esac
fi
