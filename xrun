#!/bin/bash

#==============================================================================
# Color Codes
#==============================================================================
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

#==============================================================================
# Branch Configuration
#==============================================================================
CONFIG_BRANCH="main"
if [[ -f "$HOME/.xfce_branch" ]]; then
    CONFIG_BRANCH=$(cat "$HOME/.xfce_branch")
fi

# Set INSTALLER_BRANCH if empty
if [[ -z "${INSTALLER_BRANCH:-}" ]]; then
    export INSTALLER_BRANCH="$CONFIG_BRANCH"
fi

#==============================================================================
# Logging Setup
#==============================================================================
LOG_FILE="$HOME/xfce_gpu.log"

log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $*"
    echo "$msg" >> "$LOG_FILE"
}

SCRIPT_PATH="${BASH_SOURCE[0]}"
if [[ -f "$SCRIPT_PATH" ]]; then
    XRUN_DATE=$(ls -l "$SCRIPT_PATH" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "$SCRIPT_PATH" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "$SCRIPT_PATH" 2>/dev/null || date -r "$SCRIPT_PATH" '+%b %d %H:%M' 2>/dev/null || echo "Unknown")
    echo "File date: ${XRUN_DATE}"
    echo ""
fi

#==============================================================================
# GPU Configuration Functions - Termux Layer
#==============================================================================

# Helper function for Turnip environment variables
get_turnip_env() {
    local level="$1"
    case "$level" in
        basic)
            echo "MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_GL_VERSION_OVERRIDE=4.0"
            ;;
        optimized)
            echo "MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0"
            ;;
        aggressive)
            echo "MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,sysmem ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0"
            ;;
    esac
}

prompt_termux_gpu() {
    local for_proot="${1:-false}"  # New parameter to detect if called for debian_xfce
    local egl=$(getprop ro.hardware.egl)
    local vulkan=$(getprop ro.hardware.vulkan)
    if [[ "$egl" == "$vulkan" ]]; then
        local gpu_info="$egl"
    else
        local gpu_info="$egl / $vulkan"
    fi
    
    echo "Select GPU acceleration mode:" > /dev/tty
    
    if [[ "$for_proot" == "true" ]]; then
        echo "  0) No Termux GPU (proceed to proot GPU selection)" > /dev/tty
    else
        echo "  0) Software rendering (no GPU)" > /dev/tty
    fi
    
    echo "  1) Auto-detect (recommended)" > /dev/tty
    echo "" > /dev/tty
    
    # Hide Turnip options for debian_xfce (Turnip doesn't work in proot)
    if [[ "$for_proot" == "false" ]]; then
        echo "  --- Direct GPU (Adreno 6XX/7XX only) ---" > /dev/tty
        echo "  2) Turnip Basic (direct Vulkan)" > /dev/tty
        echo "  3) Turnip Optimized (+ threading, descriptor caching)" > /dev/tty
        echo "  4) Turnip Aggressive (experimental, best for gaming)" > /dev/tty
        echo "" > /dev/tty
    fi
    
    echo "  --- Universal (works on all GPUs) ---" > /dev/tty
    echo "  5) VIRGL Android (server for proot)" > /dev/tty
    echo "  6) VIRGL Android + ANGLE (Mali optimized)" > /dev/tty
    echo "  7) ZINK Android (server for proot)" > /dev/tty
    echo "  8) ZINK EGL Surfaceless (advanced)" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Advanced ---" > /dev/tty
    echo "  9) Custom (enter your own commands)" > /dev/tty
    if [[ "$for_proot" == "true" ]]; then
        echo "" > /dev/tty
        echo "  --- Proot Test Options (no Termux server) ---" > /dev/tty
        echo "  10) Test Proot (default, no GPU env vars)" > /dev/tty
    fi
    echo "" > /dev/tty
    echo -n "Choice [0-10]: " > /dev/tty
    read -r gpu_choice < /dev/tty
    gpu_choice=$(echo "$gpu_choice" | tr -cd '0-9')
    [[ -z "$gpu_choice" ]] && gpu_choice="0"
    
    # Validate: reject Turnip options (2-4) if for_proot=true
    if [[ "$for_proot" == "true" ]] && [[ "$gpu_choice" =~ ^[2-4]$ ]]; then
        echo -e "${YELLOW}⚠ Turnip doesn't work in proot. Using no GPU server (0)${NC}" > /dev/tty
        gpu_choice="0"
    fi
    
    echo "$gpu_choice"
}

apply_termux_gpu() {
    local gpu_choice="$1"
    local launch_xfce="${2:-true}"
    local gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    
    log "apply_termux_gpu: gpu_choice='$gpu_choice', launch_xfce='$launch_xfce'"
    
    if [[ "$gpu_choice" == "0" ]]; then
        if [[ "$launch_xfce" == "true" ]]; then
            echo -e "${YELLOW}[Termux XFCE]${NC} Software rendering mode (No acceleration)" | tee -a ~/xfce_gpu.log
            log "Launching XFCE in software rendering mode"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Option 0: Skipping Termux GPU setup, proceeding to proot GPU selection"
        fi
    elif [[ "$gpu_choice" == "1" ]]; then
        local egl=$(getprop ro.hardware.egl)
        local vulkan=$(getprop ro.hardware.vulkan)
        local renderer=$(getprop ro.hardware.renderer 2>/dev/null || echo "unknown")
        
        echo "" | tee -a ~/xfce_gpu.log
        echo -e "${CYAN}=== Auto-detect GPU ===${NC}" | tee -a ~/xfce_gpu.log
        echo "EGL: $egl" | tee -a ~/xfce_gpu.log
        echo "Vulkan: $vulkan" | tee -a ~/xfce_gpu.log
        echo "Renderer: $renderer" | tee -a ~/xfce_gpu.log
        echo "" | tee -a ~/xfce_gpu.log
        
        if echo "$egl $vulkan" | grep -iq "adreno"; then
            if [[ "$launch_xfce" == "false" ]]; then
                echo -e "${GREEN}✓ Adreno GPU detected → No Termux server (Option 0)${NC}" | tee -a ~/xfce_gpu.log
                log "Auto-detect: Adreno detected (proot mode), redirecting to option 0"
                apply_termux_gpu "0" "$launch_xfce"
            else
                echo -e "${GREEN}✓ Adreno GPU detected → Using Turnip Aggressive (Option 4)${NC}" | tee -a ~/xfce_gpu.log
                log "Auto-detect: Adreno detected, redirecting to option 4"
                apply_termux_gpu "4" "$launch_xfce"
            fi
            return
        elif echo "$egl $vulkan" | grep -iq "mali"; then
            echo -e "${GREEN}✓ Mali GPU detected → Using VIRGL + ANGLE (Option 6)${NC}" | tee -a ~/xfce_gpu.log
            log "Auto-detect: Mali detected, redirecting to option 6"
            apply_termux_gpu "6" "$launch_xfce"
            return
        else
            if [[ "$launch_xfce" == "false" ]]; then
                echo -e "${YELLOW}⚠ Unknown GPU → No Termux server (Option 0, safe fallback)${NC}" | tee -a ~/xfce_gpu.log
                log "Auto-detect: Unknown GPU (proot mode), redirecting to option 0"
                apply_termux_gpu "0" "$launch_xfce"
            else
                echo -e "${YELLOW}⚠ Unknown GPU → Using VIRGL Basic (Option 5, safe fallback)${NC}" | tee -a ~/xfce_gpu.log
                log "Auto-detect: Unknown GPU, redirecting to option 5"
                apply_termux_gpu "5" "$launch_xfce"
            fi
            return
        fi
    elif [[ "$gpu_choice" == "2" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Basic (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Basic"
            local turnip_env=$(get_turnip_env "basic")
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink $turnip_env xfce4-session &
        else
            log "Turnip Basic: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "3" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Optimized (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Optimized"
            local turnip_env=$(get_turnip_env "optimized")
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink $turnip_env xfce4-session &
        else
            log "Turnip Optimized: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "4" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Turnip Aggressive (Adreno 6XX/7XX)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Turnip Aggressive"
            local turnip_env=$(get_turnip_env "aggressive")
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink $turnip_env xfce4-session &
        else
            log "Turnip Aggressive: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "5" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL Android" | tee -a ~/xfce_gpu.log
        log "Starting VIRGL Android server"
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "6" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL Android + ANGLE" | tee -a ~/xfce_gpu.log
        log "Starting VIRGL Android + ANGLE server"
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "7" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK Android" | tee -a ~/xfce_gpu.log
        log "Starting ZINK Android server"
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink virgl_test_server_android &
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "8" ]]; then
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK EGL Surfaceless" | tee -a ~/xfce_gpu.log
        log "Starting ZINK EGL Surfaceless server"
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "9" ]]; then
        echo -e "${YELLOW}[Termux XFCE]${NC} Custom Mode (Advanced)" | tee -a ~/xfce_gpu.log
        log "Custom mode selected"
        
        echo -n "Start a server? (y/n): " > /dev/tty
        read -r need_server < /dev/tty
        
        if [[ "$need_server" =~ ^[Yy]$ ]]; then
            echo "Enter server command:" > /dev/tty
            echo "Example: GALLIUM_DRIVER=zink virgl_test_server_android" > /dev/tty
            echo -n "> " > /dev/tty
            read -r server_cmd < /dev/tty
            
            if [[ -n "$server_cmd" ]]; then
                log "Custom server: $server_cmd"
                eval "$server_cmd &"
                sleep 2
            fi
        fi
        
        if [[ "$launch_xfce" == "true" ]]; then
            echo "Enter environment variables for XFCE:" > /dev/tty
            echo "Example: GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0" > /dev/tty
            echo -n "> " > /dev/tty
            read -r custom_env < /dev/tty
            
            log "Custom env: $custom_env"
            
            if [[ -n "$custom_env" ]]; then
                dbus-launch --exit-with-session env $custom_env xfce4-session &
            else
                dbus-launch --exit-with-session xfce4-session &
            fi
        fi
    else
        echo -e "${YELLOW}[Termux XFCE]${NC} Invalid choice, using software rendering" | tee -a ~/xfce_gpu.log
        log "Invalid gpu_choice='$gpu_choice', using software rendering"
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE in software rendering mode"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Software rendering: Skipping XFCE launch"
        fi
    fi
}

#==============================================================================
# GPU Configuration Functions - Proot Layer
#==============================================================================

prompt_proot_driver() {
    clear
    local DEBIAN_ROOT="$PREFIX/var/lib/proot-distro/installed-rootfs/debian"
    local gpu_server="${1:-false}"
    
    echo "" > /dev/tty
    echo -e "${CYAN}[Debian Proot]${NC} Select GPU driver:" > /dev/tty
    echo "  0) Software rendering (LLVMPIPE)" > /dev/tty
    echo "  1) Auto-detect (recommended)" > /dev/tty
    
    if [[ "$gpu_server" == "true" ]]; then
        echo "" > /dev/tty
        echo "  --- Universal (works on all GPUs) ---" > /dev/tty
        echo "  2) VIRGL Basic (OpenGL via GPU server)" > /dev/tty
        echo "  3) VIRGL Optimized (OpenGL + threading)" > /dev/tty
        echo "  4) ZINK Basic (Vulkan via GPU server)" > /dev/tty
        echo "  5) ZINK Optimized (Vulkan + threading)" > /dev/tty
    else
        echo "" > /dev/tty
        echo -e "  ${YELLOW}VIRGL/ZINK unavailable (no GPU server)${NC}" > /dev/tty
    fi
    
    echo "" > /dev/tty
    echo "  --- Software Rendering (no server needed) ---" > /dev/tty
    echo "  6) Force LLVMPIPE (ignore any GPU drivers)" > /dev/tty
    echo "  7) Disable Vulkan + Force LLVMPIPE" > /dev/tty
    echo "" > /dev/tty
    echo "  --- Advanced ---" > /dev/tty
    echo "  9) Custom (enter your own environment variables)" > /dev/tty
    echo "" > /dev/tty
    echo -n "Choice [0-9]: " > /dev/tty
    read -r driver_choice < /dev/tty
    driver_choice=$(echo "$driver_choice" | tr -cd '0-9')
    [[ -z "$driver_choice" ]] && driver_choice="0"
    
    # Validate: reject options 2-5 if no GPU server
    if [[ "$gpu_server" == "false" ]] && [[ "$driver_choice" =~ ^[2-5]$ ]]; then
        echo -e "${YELLOW}⚠ Options 2-5 require GPU server. Using software rendering (0)${NC}" > /dev/tty
        driver_choice="0"
    fi
    
    echo "$driver_choice"
}

apply_proot_driver() {
    local driver_choice="$1"
    local username="$2"
    
    log "apply_proot_driver: driver_choice='$driver_choice', username='$username'"
    
    if [[ "$driver_choice" == "0" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Software rendering mode (LLVMPIPE)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE in software rendering mode"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "1" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Auto-detect mode (should not reach here)" | tee -a ~/xfce_gpu.log
        log "Proot: Auto-detect fallback to VIRGL Basic"
        apply_proot_driver "2" "$username"
    elif [[ "$driver_choice" == "2" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL Basic" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VIRGL Basic"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "3" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL Optimized" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VIRGL Optimized"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "4" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK Basic" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with ZINK Basic"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "5" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK Optimized" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with ZINK Optimized"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "6" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Force LLVMPIPE (software rendering)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with LIBGL_ALWAYS_SOFTWARE=1"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 LIBGL_ALWAYS_SOFTWARE=1 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "7" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Disable Vulkan + Force LLVMPIPE" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VK_ICD_FILENAMES=/dev/null LIBGL_ALWAYS_SOFTWARE=1"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 VK_ICD_FILENAMES=/dev/null LIBGL_ALWAYS_SOFTWARE=1 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "9" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Custom Mode (Advanced)" | tee -a ~/xfce_gpu.log
        log "Proot: Custom mode selected"
        
        echo "Enter environment variables for Debian XFCE:" > /dev/tty
        echo "Example: GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0" > /dev/tty
        echo -n "> " > /dev/tty
        read -r custom_env < /dev/tty
        
        log "Proot custom env: $custom_env"
        
        if [[ -n "$custom_env" ]]; then
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 $custom_env dbus-launch --exit-with-session xfce4-session
        else
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
        fi
    else
        echo -e "${YELLOW}[Debian XFCE]${NC} Invalid choice, using software rendering" | tee -a ~/xfce_gpu.log
        log "Proot: Invalid driver_choice='$driver_choice', using software rendering"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    fi
}

#==============================================================================
# Desktop Environment Launchers
#==============================================================================

start_xfce() {
    log "start_xfce: Starting Native Termux XFCE"
    echo -e "${GREEN}[Termux XFCE]${NC} GPU: $(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)" | tee -a ~/xfce_gpu.log
    echo "" > /dev/tty
    gpu_choice=$(prompt_termux_gpu "false")  # Show all options including Turnip
    log "start_xfce: User selected GPU mode $gpu_choice"
    
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        log "start_xfce: Samsung device detected, using libskcodec.so"
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        log "start_xfce: Starting pulseaudio"
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0
    mkdir -p "$XDG_RUNTIME_DIR"

    log "start_xfce: Starting Termux-X11 server"
    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1
    
    apply_termux_gpu "$gpu_choice" "true"
}

start_debian_xfce() {
    log "start_debian_xfce: Starting Debian XFCE"
    echo -e "${GREEN}[Debian XFCE]${NC} GPU: $(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)" | tee -a ~/xfce_gpu.log
    echo ""
    termux_gpu_choice=$(prompt_termux_gpu "true")  # Hide Turnip, change option 0 text
    log "start_debian_xfce: Termux GPU choice=$termux_gpu_choice"
    
    # Check if GPU server will be started (options 5-8)
    local gpu_server="false"
    if [[ "$termux_gpu_choice" =~ ^[5-8]$ ]]; then
        gpu_server="true"
        log "GPU server will be started (choice $termux_gpu_choice)"
    else
        log "No GPU server (choice $termux_gpu_choice)"
    fi
    
    username=$(get_debian_username)
    log "start_debian_xfce: Debian username=$username"
    
    # Handle option 10 (Test Proot - pure software rendering)
    if [[ "$termux_gpu_choice" == "10" ]]; then
        log "Test Proot mode: Pure software rendering (no server, no GPU)"
        echo ""
        echo -e "${YELLOW}[Test Proot]${NC} Software rendering only (no GPU acceleration)"
        
        if ! pgrep -f "termux-x11" > /dev/null; then
            kill -9 $(pgrep -f "termux.x11") 2>/dev/null
            
            if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
                LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
            else
                pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
            fi
            
            export PULSE_SERVER=127.0.0.1
            export XDG_RUNTIME_DIR=${TMPDIR}
            mkdir -p "$XDG_RUNTIME_DIR"
            
            termux-x11 :0 >/dev/null &
            sleep 3
            
            am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
            sleep 1
        fi
        
        echo -e "${YELLOW}[Debian XFCE]${NC} Software rendering mode (LLVMPIPE)" | tee -a ~/xfce_gpu.log
        log "Test Proot: Launching proot with software rendering"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
        return
    fi
    
    
    # Show 2nd prompt for proot driver selection
    if [[ "$termux_gpu_choice" == "1" ]]; then
        # Termux Auto was selected - show 2nd prompt
        echo ""
        proot_driver_choice=$(prompt_proot_driver "$gpu_server")
        log "Proot selection after Termux auto: $proot_driver_choice"
        
        # If user also chose auto (1) in proot, then auto-detect
        if [[ "$proot_driver_choice" == "1" ]]; then
            # Check if GPU server is running
            if [[ "$gpu_server" == "false" ]]; then
                # No GPU server - use software rendering
                proot_driver_choice="0"
                echo -e "${YELLOW}⚠ No GPU server running → Using software rendering (Option 0)${NC}" | tee -a ~/xfce_gpu.log
                log "Proot auto-detect: No GPU server, using software rendering (0)"
            else
                # GPU server running - auto-detect GPU type
                local egl=$(getprop ro.hardware.egl)
                local vulkan=$(getprop ro.hardware.vulkan)
                
                if echo "$egl $vulkan" | grep -iq "adreno"; then
                    proot_driver_choice="3"  # VIRGL Optimized for Adreno
                    echo -e "${GREEN}✓ Adreno detected → Proot using VIRGL Optimized (Option 3)${NC}" | tee -a ~/xfce_gpu.log
                    log "Proot auto-detect: Adreno, using VIRGL Optimized (3)"
                elif echo "$egl $vulkan" | grep -iq "mali"; then
                    proot_driver_choice="3"  # VIRGL Optimized
                    echo -e "${GREEN}✓ Mali detected → Using VIRGL Optimized (Option 3)${NC}" | tee -a ~/xfce_gpu.log
                    log "Proot auto-detect: Mali, using VIRGL Optimized (3)"
                else
                    proot_driver_choice="2"  # VIRGL Basic
                    echo -e "${YELLOW}⚠ Unknown GPU → Using VIRGL Basic (Option 2)${NC}" | tee -a ~/xfce_gpu.log
                    log "Proot auto-detect: Unknown GPU, using VIRGL Basic (2)"
                fi
            fi
        fi
    elif [[ "$termux_gpu_choice" == "0" ]]; then
        # No Termux GPU - proceed to 2nd prompt
        echo ""
        echo -e "${CYAN}Step 2: Proot GPU (driver)${NC}"
        proot_driver_choice=$(prompt_proot_driver "$gpu_server")
        
        # User chose 0 - respect their choice for software rendering
        log "Proot manual selection: $proot_driver_choice"
    else
        # Manual selection (5-9), show prompt
        echo ""
        echo "Step 2: Proot GPU (driver)"
        proot_driver_choice=$(prompt_proot_driver "$gpu_server")
        log "start_debian_xfce: Proot driver choice=$proot_driver_choice (manual)"
    fi
    
    if ! pgrep -f "termux-x11" > /dev/null; then
        log "start_debian_xfce: Termux-X11 not running, starting..."
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            log "start_debian_xfce: Samsung device detected"
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    else
        log "start_debian_xfce: Termux-X11 already running"
    fi
    
    log "Debian XFCE: Starting GPU server (server-only mode)"
    apply_termux_gpu "$termux_gpu_choice" "false"
    log "GPU server started, waiting before launching proot"
    sleep 2
    
    log "Debian XFCE: Launching proot with driver choice=$proot_driver_choice"
    apply_proot_driver "$proot_driver_choice" "$username"
}

start_debian() {
    log "start_debian: Entering Debian proot CLI"
    username=$(get_debian_username)
    export DISPLAY=:0
    proot-distro login debian --user $username --shared-tmp
}

#==============================================================================
# Helper Functions
#==============================================================================

# Get GPU model name (e.g., "Adreno 650")
get_gpu_model() {
    # Try multiple methods to get GPU model
    local gpu_model=""
    
    # Method 1: Check ro.soc.model or ro.chipname
    gpu_model=$(getprop ro.soc.model 2>/dev/null)
    if [[ -n "$gpu_model" && "$gpu_model" != "" ]]; then
        echo "$gpu_model"
        return
    fi
    
    # Method 2: Check ro.hardware.chipname
    gpu_model=$(getprop ro.hardware.chipname 2>/dev/null)
    if [[ -n "$gpu_model" && "$gpu_model" != "" ]]; then
        echo "$gpu_model"
        return
    fi
    
    # Method 3: Check ro.board.platform
    gpu_model=$(getprop ro.board.platform 2>/dev/null)
    if [[ -n "$gpu_model" && "$gpu_model" != "" ]]; then
        echo "$gpu_model"
        return
    fi
    
    # Method 4: Parse from /proc/cpuinfo
    if [[ -f /proc/cpuinfo ]]; then
        gpu_model=$(grep -i "hardware" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
        if [[ -n "$gpu_model" ]]; then
            echo "$gpu_model"
            return
        fi
    fi
    
    # Method 5: Check vulkaninfo output
    if command -v vulkaninfo &>/dev/null; then
        gpu_model=$(vulkaninfo 2>/dev/null | grep -i "deviceName" | head -1 | cut -d= -f2 | xargs)
        if [[ -n "$gpu_model" ]]; then
            echo "$gpu_model"
            return
        fi
    fi
    
    # Fallback: Use driver name
    gpu_model=$(getprop ro.hardware.vulkan 2>/dev/null || get_gpu_info)
    echo "$gpu_model"
}

# Get GPU info helper
get_gpu_info() {
    local egl=$(getprop ro.hardware.egl)
    local vulkan=$(getprop ro.hardware.vulkan)
    if [[ "$egl" == "$vulkan" ]]; then
        echo "$egl"
    else
        echo "$egl / $vulkan"
    fi
}

# Detect GPU type (adreno, mali, or unknown)
detect_gpu_type() {
    local gpu_info=$(get_gpu_info | tr '[:upper:]' '[:lower:]')
    
    if [[ "$gpu_info" =~ adreno|freedreno|qcom|qualcomm ]]; then
        echo "adreno"
    elif [[ "$gpu_info" =~ mali|panfrost|midgard|bifrost ]]; then
        echo "mali"
    else
        echo "unknown"
    fi
}

get_debian_username() {
    basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*
}

get_file_date() {
    if [[ -f "${BASH_SOURCE[0]}" ]]; then
        ls -l "${BASH_SOURCE[0]}" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "${BASH_SOURCE[0]}" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "${BASH_SOURCE[0]}" 2>/dev/null || date -r "${BASH_SOURCE[0]}" '+%b %d %H:%M' 2>/dev/null || echo "Unknown"
    elif [[ -f "xrun" ]]; then
        ls -l "xrun" 2>/dev/null | awk '{print $6, $7, $8}' || stat -c %y "xrun" 2>/dev/null | cut -d' ' -f1,2 | cut -d'.' -f1 || stat -f "%Sm" -t "%b %d %H:%M" "xrun" 2>/dev/null || date -r "xrun" '+%b %d %H:%M' 2>/dev/null || echo "Unknown"
    else
        echo "Unknown"
    fi
}

#==============================================================================
# GPU Driver Management
#==============================================================================

manage_gpu_drivers() {
    while true; do
        clear
        echo "=== GPU Driver Management ==="
        echo ""
        
        # Show GPU hardware info
        local gpu_type=$(detect_gpu_type)
        local gpu_model=$(get_gpu_model)
        echo "GPU Hardware: $gpu_model ($gpu_type)"
        
        # Show Termux Mesa version
        if pkg list-installed 2>/dev/null | grep -q "^mesa"; then
            local mesa_version=$(pkg list-installed 2>/dev/null | grep "^mesa" | head -1 | awk '{print $2}')
            echo "Termux Mesa: $mesa_version"
        fi
        
        # Show Vulkan API version
        if command -v vulkaninfo &>/dev/null; then
            local vulkan_version=$(vulkaninfo 2>/dev/null | grep -i "vulkan" | grep -i "version" | head -1 | awk '{print $NF}')
            if [[ -n "$vulkan_version" ]]; then
                echo "Vulkan API: $vulkan_version"
            fi
        fi
        
        echo ""
        
        # Show Debian proot driver status (if Adreno)
        if [[ "$gpu_type" == "adreno" ]]; then
            echo "Debian Proot Driver Status:"
            
            # Check current Mesa version
            local mesa_ver=$(proot-distro login debian --shared-tmp -- dpkg-query -W -f='${Version}' mesa-vulkan-drivers 2>/dev/null || echo "not installed")
            
            # Determine if custom Turnip is installed
            if [[ "$mesa_ver" == *"24.1.0"* ]]; then
                echo "├─ mesa-vulkan-drivers: $mesa_ver"
                echo "└─ Custom Turnip: Installed (held)"
            elif [[ "$mesa_ver" != "not installed" ]]; then
                echo "├─ mesa-vulkan-drivers: $mesa_ver"
                echo "└─ Custom Turnip: Not installed (using default Mesa)"
            else
                echo "└─ mesa-vulkan-drivers: not installed"
            fi
            echo ""
        fi
        
        # Show options
        echo "Options:"
        echo "  1) Install Turnip driver (24.1.0, Adreno optimized)"
        echo "  2) Restore default Mesa drivers"
        echo "  3) Run GPU benchmark (glmark2)"
        echo "  9) Debug GPU detection"
        echo "  0) Back to main menu"
        echo ""
        echo -n "Choice: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1) install_turnip_driver ;;
            2) restore_default_drivers ;;
            3) run_benchmark ;;
            9) debug_gpu_detection ;;
            0) return ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option.${NC}"
                sleep 1
                ;;
        esac
    done
}

install_turnip_driver() {
    echo ""
    echo "=== Install Turnip Driver ==="
    echo ""
    echo "This will install custom Turnip driver (24.1.0) for Adreno GPUs."
    echo "The driver will be pinned to prevent automatic updates."
    echo ""
    
    local DEBIAN_ROOT="$PREFIX/var/lib/proot-distro/installed-rootfs/debian"
    
    # Check if Debian is installed
    if [[ ! -d "$DEBIAN_ROOT" ]]; then
        echo -e "${YELLOW}Error: Debian proot not found.${NC}"
        echo "Please install Debian first."
        echo -n "Press Enter to continue..." > /dev/tty
        read < /dev/tty
        return
    fi
    
    # Check if already installed
    local existing_ver=$(proot-distro login debian --shared-tmp -- dpkg-query -W -f='${Version}' mesa-vulkan-drivers 2>/dev/null || echo "")
    if [[ "$existing_ver" == *"24.1.0"* ]]; then
        echo "Custom Turnip version already installed: $existing_ver"
        echo "This will reinstall version 24.1.0"
        echo ""
    elif [[ -n "$existing_ver" ]]; then
        echo "Current Mesa version: $existing_ver"
        echo "This will replace with custom Turnip 24.1.0"
        echo ""
    else
        echo "No Mesa drivers currently installed."
        echo "This will install custom Turnip 24.1.0"
        echo ""
    fi
    
    echo -n "Continue? (y/N): " > /dev/tty
    read -r confirm < /dev/tty
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        sleep 1
        return
    fi
    
    local deb_file="mesa-vulkan-kgsl_24.1.0-devel-20240120_arm64.deb"
    local temp_deb="${TMPDIR}/$deb_file"
    local release_url="https://github.com/Jessiebrig/termux_dual_xfce/releases/download/turnip-driver-v24.1.0/$deb_file"
    
    echo ""
    echo "Downloading Turnip driver..."
    echo "URL: $release_url"
    echo ""
    
    # Download with progress and follow redirects
    curl -L --progress-bar "$release_url" -o "$temp_deb"
    local curl_exit=$?
    
    if [[ $curl_exit -ne 0 ]]; then
        echo ""
        echo -e "${YELLOW}Download failed (curl exit code: $curl_exit)${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  - Exit code 23: Write error (check disk space)"
        echo "  - Try: pkg install ca-certificates"
        echo "  - Check internet connection"
        rm -f "$temp_deb"
        echo -n "Press Enter to continue..." > /dev/tty
        read < /dev/tty
        return
    fi
    echo ""
    
    # Verify download
    if [[ ! -f "$temp_deb" ]] || [[ ! -s "$temp_deb" ]]; then
        echo -e "${YELLOW}Error: Downloaded file is empty or missing.${NC}"
        rm -f "$temp_deb"
        echo -n "Press Enter to continue..." > /dev/tty
        read < /dev/tty
        return
    fi
    
    echo "Download complete. File size: $(du -h "$temp_deb" | cut -f1)"
    echo "Installing Turnip driver..."
    
    # Install and hold mesa-vulkan-drivers at this version
    if proot-distro login debian --shared-tmp -- bash -c "dpkg -i --force-depends $temp_deb && apt-mark hold mesa-vulkan-drivers && rm -f $temp_deb" 2>&1; then
        echo ""
        echo -e "${GREEN}✓ Turnip driver installed successfully!${NC}"
        echo "Driver version: 24.1.0 (held from updates)"
    else
        echo ""
        echo -e "${YELLOW}Installation failed. Check error messages above.${NC}"
        rm -f "$temp_deb"
    fi
    
    echo ""
    echo -n "Press Enter to continue..." > /dev/tty
    read < /dev/tty
}

restore_default_drivers() {
    echo ""
    echo "=== Restore Default Mesa Drivers ==="
    echo ""
    echo "This will remove custom Turnip driver and reinstall default Mesa."
    echo ""
    echo -n "Continue? (y/N): " > /dev/tty
    read -r confirm < /dev/tty
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        sleep 1
        return
    fi
    
    echo ""
    echo "Removing custom Turnip driver..."
    proot-distro login debian --shared-tmp -- bash -c "apt-mark unhold mesa-vulkan-drivers 2>/dev/null; apt install --reinstall -y mesa-vulkan-drivers"
    
    echo ""
    echo -e "${GREEN}✓ Default Mesa drivers restored.${NC}"
    echo ""
    echo -n "Press Enter to continue..." > /dev/tty
    read < /dev/tty
}

run_benchmark() {
    echo ""
    echo "=== GPU Benchmark (Debian Proot) ==="
    echo ""
    
    # Check if glmark2-x11 is installed
    if ! proot-distro login debian --shared-tmp -- command -v glmark2 &>/dev/null; then
        echo "glmark2-x11 not installed in Debian proot."
        echo -n "Install now? (y/N): " > /dev/tty
        read -r install_choice < /dev/tty
        
        if [[ "$install_choice" =~ ^[Yy]$ ]]; then
            echo "Installing glmark2-x11..."
            proot-distro login debian --shared-tmp -- apt install -y glmark2-x11
        else
            echo "Benchmark cancelled."
            echo -n "Press Enter to continue..." > /dev/tty
            read < /dev/tty
            return
        fi
    fi
    
    echo "Select benchmark mode:"
    echo "  1) Default (quick test)"
    echo "  2) With Turnip env vars (if Turnip installed)"
    echo "  0) Cancel"
    echo ""
    echo -n "Choice: " > /dev/tty
    read bench_choice < /dev/tty
    
    case $bench_choice in
        1)
            echo ""
            echo "Running glmark2 in Debian proot..."
            echo "This will take about 30-60 seconds."
            echo ""
            proot-distro login debian --shared-tmp -- env DISPLAY=:0 glmark2
            ;;
        2)
            local DEBIAN_ROOT="$PREFIX/var/lib/proot-distro/installed-rootfs/debian"
            if [[ ! -f "$DEBIAN_ROOT/usr/lib/aarch64-linux-gnu/libvulkan_freedreno.so" ]]; then
                echo ""
                echo "Turnip driver not installed. Using default mode."
                sleep 2
                proot-distro login debian --shared-tmp -- env DISPLAY=:0 glmark2
            else
                echo ""
                echo "Running glmark2 with Turnip optimizations..."
                echo "This will take about 30-60 seconds."
                echo ""
                proot-distro login debian --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform glmark2
            fi
            ;;
        0)
            return
            ;;
    esac
    
    echo ""
    echo -n "Press Enter to continue..." > /dev/tty
    read < /dev/tty
}

debug_gpu_detection() {
    echo ""
    echo "=== GPU Detection Debug ==="
    echo ""
    echo "Testing all detection methods:"
    echo ""
    
    echo "Method 1 - ro.soc.model:"
    getprop ro.soc.model 2>/dev/null || echo "  (not available)"
    echo ""
    
    echo "Method 2 - ro.hardware.chipname:"
    getprop ro.hardware.chipname 2>/dev/null || echo "  (not available)"
    echo ""
    
    echo "Method 3 - ro.board.platform:"
    getprop ro.board.platform 2>/dev/null || echo "  (not available)"
    echo ""
    
    echo "Method 4 - /proc/cpuinfo (Hardware line):"
    grep -i "hardware" /proc/cpuinfo 2>/dev/null | head -1 || echo "  (not available)"
    echo ""
    
    echo "Method 5 - vulkaninfo deviceName:"
    if command -v vulkaninfo &>/dev/null; then
        vulkaninfo 2>/dev/null | grep -i "deviceName" | head -1 || echo "  (not available)"
    else
        echo "  (vulkaninfo not installed)"
    fi
    echo ""
    
    echo "Fallback - ro.hardware.vulkan:"
    getprop ro.hardware.vulkan 2>/dev/null || echo "  (not available)"
    echo ""
    
    echo "Fallback - ro.hardware.egl:"
    getprop ro.hardware.egl 2>/dev/null || echo "  (not available)"
    echo ""
    
    echo "Current result from get_gpu_model():"
    echo "  $(get_gpu_model)"
    echo ""
    
    echo -n "Press Enter to continue..." > /dev/tty
    read < /dev/tty
}

#==============================================================================
# System Utilities
#==============================================================================

show_help() {
    if [[ -n "$1" ]]; then
        echo "Unknown command: $1"
        echo ""
    fi
    echo "Available commands:"
    echo "  xrun                  - Show interactive menu"
    echo "  xrun xfce             - Launch native Termux XFCE"
    echo "  xrun debian_xfce      - Launch Debian XFCE"
    echo "  xrun debian           - Enter Debian proot shell (interactive)"
    echo "  xrun gpu              - Manage GPU drivers (experimental, Adreno only)"
    echo "  xrun kill_termux_x11  - Kill Termux-X11"
    echo "  xrun update           - Run initializer to update scripts"
    echo "  xrun help             - Show this help message"
}

kill_termux_x11() {
    log "kill_termux_x11: Stopping Termux-X11"
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
    log "kill_termux_x11: Termux-X11 stopped"
}

run_initializer() {
    log "run_initializer: Launching initializer"
    local tmp="${TMPDIR:-/tmp}/init_$$.sh"
    echo ""
    echo -e "${GREEN}Downloading initializer...${NC}"
    
    if curl -L --progress-bar https://raw.githubusercontent.com/Jessiebrig/termux_dual_xfce/main/initialize.sh -o "$tmp"; then
        chmod +x "$tmp"
        exec bash "$tmp"
    else
        echo -e "${YELLOW}Failed to download initializer.${NC}"
        echo -n "Press Enter to continue..." > /dev/tty
        read < /dev/tty
        return 1
    fi
}

#==============================================================================
# Interactive Menu
#==============================================================================

show_menu() {
    while true; do
        clear
        echo "File date: $(get_file_date)"
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian Shell"
        echo "      Enter Debian proot terminal (interactive)"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "  ${GREEN}5${NC} - GPU Drivers (Experimental)"
        echo "      Manage Debian Turnip driver (Adreno optimization)"
        echo ""
        echo -e "${CYAN}Setup:${NC}"
        echo -e "  ${GREEN}9${NC} - Check for Updates"
        echo "      Download xrun and main script from your selected branch"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-9]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                manage_gpu_drivers
                ;;
            9)
                run_initializer
                ;;
            0)
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

#==============================================================================
# Main Entry Point
#==============================================================================

if [[ $# -eq 0 ]]; then
    show_menu
else
    case "$1" in
        xfce)
            start_xfce
            ;;
        debian_xfce)
            start_debian_xfce
            ;;
        debian)
            start_debian
            ;;
        gpu)
            manage_gpu_drivers
            ;;
        kill_termux_x11)
            kill_termux_x11
            ;;
        update)
            run_initializer
            ;;
        help)
            show_help ""
            ;;
        *)
            show_help "$1"
            exit 1
            ;;
    esac
fi
