#!/bin/bash

#==============================================================================
# Color Codes
#==============================================================================
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

#==============================================================================
# Logging Setup
#==============================================================================
LOG_FILE="$HOME/xfce_gpu.log"

# Logging function - displays in terminal AND writes to log file
log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $*"
    echo "$msg"
    echo "$msg" >> "$LOG_FILE"
}

#==============================================================================
# GPU Configuration Functions - Termux Layer
#==============================================================================

# Function: Prompt for Termux GPU mode
prompt_termux_gpu() {
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    echo -e "${GREEN}[Termux XFCE]${NC} GPU: $gpu_info" | tee -a ~/xfce_gpu.log
    echo "Select GPU acceleration mode:"
    echo "  0) No acceleration (software rendering)"
    echo "  1) ZINK (Vulkan via virpipe)"
    echo "  2) VIRGL (OpenGL)"
    echo "  3) Native Turnip (Experimental)"
    echo "  4) Native Turnip + Optimizations (Experimental)"
    echo "  5) Native Turnip + Aggressive Opts (Experimental)"
    echo "  6) Pure Vulkan Mode (Experimental)"
    echo "  7) ZINK Alternative Threading (Experimental)"
    echo "  8) ZINK + Mesa Threading (Experimental)"
    echo "  9) VIRGL + Performance Opts (Experimental)"
    echo "  10) ZINK + Async Compile (Experimental)"
    echo "  11) VIRGL + Async + Threading (Experimental)"
    echo "  12) ZINK + Descriptor Caching (Experimental)"
    echo "  13) VIRGL + Texture Compression (Experimental)"
    echo "  14) ZINK + All Optimizations (Experimental)"
    echo "  15) VIRGL + All Optimizations (Experimental)"
    echo -n "Choice [0-15]: " > /dev/tty
    read -r gpu_choice < /dev/tty
    gpu_choice=$(echo "$gpu_choice" | tr -cd '0-9')
    echo "[DEBUG] You entered: '$gpu_choice' (length=${#gpu_choice})"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] prompt_termux_gpu: User entered '$gpu_choice' (length=${#gpu_choice})" >> ~/xfce_gpu.log
    echo "$gpu_choice"
}

# Function: Apply Termux GPU configuration
apply_termux_gpu() {
    local gpu_choice="$1"
    local launch_xfce="${2:-true}"
    local gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    
    echo "[DEBUG] apply_termux_gpu received: gpu_choice='$gpu_choice' (length=${#gpu_choice}), launch_xfce='$launch_xfce'"
    log "apply_termux_gpu: gpu_choice='$gpu_choice', launch_xfce='$launch_xfce'"
    
    if [[ "$gpu_choice" == "0" ]]; then
        # Software rendering (No acceleration)
        echo -e "${YELLOW}[Termux XFCE]${NC} Software rendering mode (No acceleration)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE in software rendering mode"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Software rendering: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "1" ]]; then
        # ZINK (Vulkan via virpipe)
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK (Vulkan via virpipe)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting ZINK server (Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        else
            log "Starting ZINK server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with ZINK"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "2" ]]; then
        # VIRGL (OpenGL)
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL (OpenGL)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            log "Starting VIRGL server (Mali GPU with ANGLE)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        else
            log "Starting VIRGL server (Non-Mali GPU)"
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE session with VIRGL"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Server-only mode: Skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "3" ]]; then
        # Native Turnip (Direct Vulkan)
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip (Experimental)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE with Native Turnip"
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        else
            log "Turnip mode: No server needed, skipping XFCE launch"
        fi
    elif [[ "$gpu_choice" == "4" ]]; then
        # Native Turnip with optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip + Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "5" ]]; then
        # Native Turnip with aggressive optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip + Aggressive Opts (Experimental)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,sysmem ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "6" ]]; then
        # Pure Vulkan mode
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Pure Vulkan Mode (Experimental)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink VK_ICD_FILENAMES=/vendor/etc/vulkan/icd.d/qualcomm.adreno.json MESA_VK_WSI_PRESENT_MODE=immediate TU_DEBUG=noconform MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "7" ]]; then
        # ZINK with alternative threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK Alternative Threading (Experimental)" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,nolrz ZINK_DEBUG=nir GALLIUM_THREAD=0 MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "8" ]]; then
        # ZINK + Mesa Threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Mesa Threading (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "9" ]]; then
        # VIRGL + Performance Opts
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Performance Opts (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "10" ]]; then
        # ZINK + Async Compile
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Async Compile (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_SHADER_CACHE_DISABLE=false MESA_GLSL_CACHE_DISABLE=false allow_glsl_extension_directive_midshader=true MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "11" ]]; then
        # VIRGL + Async + Threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Async + Threading (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "12" ]]; then
        # ZINK + Descriptor Caching
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Descriptor Caching (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy ZINK_DEBUG=compact virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy ZINK_DEBUG=compact virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe ZINK_DESCRIPTORS=lazy MESA_SHADER_CACHE_DISABLE=false MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "13" ]]; then
        # VIRGL + Texture Compression
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Texture Compression (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 force_s3tc_enable=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 force_s3tc_enable=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe force_s3tc_enable=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "14" ]]; then
        # ZINK + All Optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + All Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    elif [[ "$gpu_choice" == "15" ]]; then
        # VIRGL + All Optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + All Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true force_s3tc_enable=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true force_s3tc_enable=true virgl_test_server_android &
        fi
        sleep 2
        if [[ "$launch_xfce" == "true" ]]; then
            dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true force_s3tc_enable=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
        fi
    else
        # Invalid choice - fallback to software rendering
        log "apply_termux_gpu: Invalid gpu_choice='$gpu_choice' - falling back to software rendering"
        echo -e "${YELLOW}[Termux XFCE]${NC} Invalid choice, using software rendering" | tee -a ~/xfce_gpu.log
        if [[ "$launch_xfce" == "true" ]]; then
            log "Launching XFCE in software rendering mode (fallback)"
            dbus-launch --exit-with-session xfce4-session &
        else
            log "Software rendering fallback: Skipping XFCE launch"
        fi
    fi
}

#==============================================================================
# GPU Configuration Functions - Proot Layer
#==============================================================================

# Function: Prompt for Debian proot driver
prompt_proot_driver() {
    echo "Select proot driver:"
    echo "  0) Software rendering (no GPU)"
    echo "  1) ZINK (Vulkan via virpipe)"
    echo "  2) VIRGL (OpenGL via virpipe)"
    echo "  3) Turnip (Native Vulkan - Experimental)"
    echo -n "Choice [0-3]: " > /dev/tty
    read -r driver_choice < /dev/tty
    echo "$driver_choice"
}

# Function: Apply proot driver and launch XFCE
apply_proot_driver() {
    local driver_choice="$1"
    local username="$2"
    
    if [[ "$driver_choice" == "2" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL driver" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with VIRGL driver"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "3" ]]; then
        echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip driver (Experimental)" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with Turnip driver"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform dbus-launch --exit-with-session xfce4-session
    elif [[ "$driver_choice" == "1" ]]; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK driver" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE with ZINK driver"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    else
        echo -e "${YELLOW}[Debian XFCE]${NC} Software rendering mode" | tee -a ~/xfce_gpu.log
        log "Proot: Launching XFCE in software rendering mode"
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    fi
}

#==============================================================================
# Desktop Environment Launchers
#==============================================================================

# Function: Start native Termux XFCE
start_xfce() {
    log "start_xfce: Starting Native Termux XFCE"
    # Prompt for GPU choice
    gpu_choice=$(prompt_termux_gpu)
    log "start_xfce: User selected GPU mode $gpu_choice"
    
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    # Setup audio (experimental: Samsung-specific fix, may work for other devices)
    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        log "start_xfce: Samsung device detected, using libskcodec.so"
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        log "start_xfce: Starting pulseaudio"
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0

    # Ensure D-Bus directories exist
    mkdir -p "$XDG_RUNTIME_DIR"

    log "start_xfce: Starting Termux-X11 server"
    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1
    
    # Apply GPU configuration and launch XFCE
    apply_termux_gpu "$gpu_choice" "true"
    
    # Launch terminal with fastfetch after XFCE starts
    sleep 3
    log "start_xfce: Launching xfce4-terminal"
    DISPLAY=:0 xfce4-terminal -e "bash -c 'fastfetch; exec bash'" &
}

# Function: Start Debian XFCE
start_debian_xfce() {
    log "start_debian_xfce: Starting Debian XFCE"
    # Prompt for both GPU choices upfront
    echo -e "${GREEN}[Debian XFCE]${NC} GPU: $(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)" | tee -a ~/xfce_gpu.log
    echo ""
    echo "Step 1: Termux GPU (server)"
    termux_gpu_choice=$(prompt_termux_gpu)
    log "start_debian_xfce: Termux GPU choice=$termux_gpu_choice"
    echo ""
    echo "Step 2: Proot GPU (driver)"
    proot_driver_choice=$(prompt_proot_driver)
    log "start_debian_xfce: Proot driver choice=$proot_driver_choice"
    
    username=$(get_debian_username)
    log "start_debian_xfce: Debian username=$username"
    
    # Start Termux X11 if not already running
    if ! pgrep -f "termux-x11" > /dev/null; then
        log "start_debian_xfce: Termux-X11 not running, starting..."
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        # Setup audio
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            log "start_debian_xfce: Samsung device detected"
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    else
        log "start_debian_xfce: Termux-X11 already running"
    fi
    
    # Apply Termux GPU configuration (server only, no XFCE launch)
    log "Debian XFCE: Starting GPU server (server-only mode)"
    apply_termux_gpu "$termux_gpu_choice" "false"
    log "GPU server started, waiting before launching proot"
    sleep 2
    
    # Apply proot driver and launch XFCE
    log "Debian XFCE: Launching proot with driver choice=$proot_driver_choice"
    apply_proot_driver "$proot_driver_choice" "$username"
}

#==============================================================================
# Helper Functions
#==============================================================================

# Function: Get Debian username
get_debian_username() {
    basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*
}

# Function: Show help message
show_help() {
    if [[ -n "$1" ]]; then
        echo "Unknown command: $1"
        echo ""
    fi
    echo "Available commands:"
    echo "  xrun                  - Show interactive menu"
    echo "  xrun xfce             - Launch native Termux XFCE"
    echo "  xrun debian_xfce      - Launch Debian XFCE"
    echo "  xrun debian           - Enter Debian proot CLI"
    echo "  xrun drun <command>   - Run Debian commands"
    echo "  xrun dgpu <command>   - Run with hardware acceleration"
    echo "  xrun dfps <command>   - Run with HW accel + FPS display"
    echo "  xrun kill_termux_x11  - Kill Termux-X11"
    echo "  xrun update           - Run initializer to update scripts"
    echo "  xrun help             - Show this help message"
}

#==============================================================================
# Debian Proot Utilities
#==============================================================================

# Function: Enter Debian proot CLI
start_debian() {
    log "start_debian: Entering Debian proot CLI"
    username=$(get_debian_username)
    export DISPLAY=:0
    proot-distro login debian --user $username --shared-tmp
}

# Function: Run Debian commands
drun() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 "$@"
}

# Function: Run with hardware acceleration
dgpu() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform "$@"
}

# Function: Run with hardware acceleration + FPS display
dfps() {
    username=$(get_debian_username)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform GALLIUM_HUD=fps "$@"
}

#==============================================================================
# System Utilities
#==============================================================================

# Function: Kill Termux-X11
kill_termux_x11() {
    log "kill_termux_x11: Stopping Termux-X11"
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
    log "kill_termux_x11: Termux-X11 stopped"
}

# Function: Run initializer to update scripts
run_initializer() {
    log "run_initializer: Launching initializer script"
    echo ""
    echo -e "${GREEN}Launching initializer (downloads latest xrun and setup script)...${NC}"
    curl -sL https://raw.githubusercontent.com/Jessiebrig/termux_dual_xfce/main/initialize.sh -o ~/initialize.sh && exec bash ~/initialize.sh
}

#==============================================================================
# Interactive Menu
#==============================================================================

# Function: Show interactive menu
show_menu() {
    while true; do
        clear
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian CLI"
        echo "      Enter Debian proot terminal"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - drun <command>"
        echo "      Run Debian commands from Termux"
        echo ""
        echo -e "  ${GREEN}5${NC} - dgpu <command>"
        echo "      Run with hardware acceleration"
        echo ""
        echo -e "  ${GREEN}6${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "${CYAN}Setup:${NC}"
        echo -e "  ${GREEN}9${NC} - Check for Updates"
        echo "      Download xrun and main script from your selected branch"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-9]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    drun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    dgpu $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            6)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            9)
                run_initializer
                exit 0
                ;;
            0)
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

#==============================================================================
# Main Entry Point
#==============================================================================

# Main logic
if [[ $# -eq 0 ]]; then
    # No arguments - show interactive menu
    show_menu
else
    # Arguments provided - run the function
    case "$1" in
        xfce)
            start_xfce
            ;;
        debian_xfce)
            start_debian_xfce
            ;;
        debian)
            start_debian
            ;;
        drun)
            shift
            drun "$@"
            ;;
        dgpu)
            shift
            dgpu "$@"
            ;;
        dfps)
            shift
            dfps "$@"
            ;;
        kill_termux_x11)
            kill_termux_x11
            ;;
        update)
            run_initializer
            ;;
        help)
            show_help ""
            ;;
        *)
            show_help "$1"
            exit 1
            ;;
    esac
fi
