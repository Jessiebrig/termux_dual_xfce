#!/bin/bash

# Color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function: Start native Termux XFCE
start_xfce() {
    # GPU detection and prompt FIRST
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    echo -e "${GREEN}[Termux XFCE]${NC} GPU: $gpu_info" | tee -a ~/xfce_gpu.log
    echo "Select GPU acceleration mode:"
    echo "  0) No acceleration (software rendering)"
    echo "  1) ZINK (Vulkan via virpipe)"
    echo "  2) VIRGL (OpenGL)"
    echo "  3) Native Turnip (Experimental)"
    echo "  4) Native Turnip + Optimizations (Experimental)"
    echo "  5) Native Turnip + Aggressive Opts (Experimental)"
    echo "  6) Pure Vulkan Mode (Experimental)"
    echo "  7) ZINK Alternative Threading (Experimental)"
    echo "  8) ZINK + Mesa Threading (Experimental)"
    echo "  9) VIRGL + Performance Opts (Experimental)"
    echo "  10) ZINK + Async Compile (Experimental)"
    echo "  11) VIRGL + Async + Threading (Experimental)"
    echo "  12) ZINK + Descriptor Caching (Experimental)"
    echo "  13) VIRGL + Texture Compression (Experimental)"
    echo "  14) ZINK + All Optimizations (Experimental)"
    echo "  15) VIRGL + All Optimizations (Experimental)"
    echo -n "Choice [0-15]: " > /dev/tty
    read -r gpu_choice < /dev/tty
    
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    # Setup audio (experimental: Samsung-specific fix, may work for other devices)
    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0

    # Ensure D-Bus directories exist
    mkdir -p "$XDG_RUNTIME_DIR"

    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1
    
    if [[ "$gpu_choice" == "1" ]]; then
        # ZINK (Vulkan via virpipe)
        echo -e "${GREEN}[Termux XFCE]${NC} Using ZINK (Vulkan via virpipe)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "2" ]]; then
        # VIRGL (OpenGL)
        echo -e "${GREEN}[Termux XFCE]${NC} Using VIRGL (OpenGL)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "3" ]]; then
        # Native Turnip (Direct Vulkan)
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip (Experimental)" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "4" ]]; then
        # Native Turnip with optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip + Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "5" ]]; then
        # Native Turnip with aggressive optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Native Turnip + Aggressive Opts (Experimental)" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,sysmem ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "6" ]]; then
        # Pure Vulkan mode
        echo -e "${YELLOW}[Termux XFCE]${NC} Using Pure Vulkan Mode (Experimental)" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink VK_ICD_FILENAMES=/vendor/etc/vulkan/icd.d/qualcomm.adreno.json MESA_VK_WSI_PRESENT_MODE=immediate TU_DEBUG=noconform MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "7" ]]; then
        # ZINK with alternative threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK Alternative Threading (Experimental)" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session env GALLIUM_DRIVER=zink MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform,nolrz ZINK_DEBUG=nir GALLIUM_THREAD=0 MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "8" ]]; then
        # ZINK + Mesa Threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Mesa Threading (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "9" ]]; then
        # VIRGL + Performance Opts
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Performance Opts (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "10" ]]; then
        # ZINK + Async Compile
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Async Compile (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe MESA_SHADER_CACHE_DISABLE=false MESA_GLSL_CACHE_DISABLE=false allow_glsl_extension_directive_midshader=true MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "11" ]]; then
        # VIRGL + Async + Threading
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Async + Threading (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "12" ]]; then
        # ZINK + Descriptor Caching
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + Descriptor Caching (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy ZINK_DEBUG=compact virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy ZINK_DEBUG=compact virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe ZINK_DESCRIPTORS=lazy MESA_SHADER_CACHE_DISABLE=false MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "13" ]]; then
        # VIRGL + Texture Compression
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + Texture Compression (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 force_s3tc_enable=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 force_s3tc_enable=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe force_s3tc_enable=true MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "14" ]]; then
        # ZINK + All Optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using ZINK + All Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server --use-egl-surfaceless --use-gles &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy mesa_glthread=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe ZINK_DESCRIPTORS=lazy mesa_glthread=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    elif [[ "$gpu_choice" == "15" ]]; then
        # VIRGL + All Optimizations
        echo -e "${YELLOW}[Termux XFCE]${NC} Using VIRGL + All Optimizations (Experimental)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true force_s3tc_enable=true virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 mesa_glthread=true force_s3tc_enable=true virgl_test_server_android &
        fi
        sleep 2
        dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe mesa_glthread=true force_s3tc_enable=true MESA_SHADER_CACHE_DISABLE=false MESA_NO_ERROR=1 vblank_mode=0 MESA_GL_VERSION_OVERRIDE=4.0 xfce4-session &
    else
        # Software rendering
        echo -e "${YELLOW}[Termux XFCE]${NC} Software rendering mode" | tee -a ~/xfce_gpu.log
        dbus-launch --exit-with-session xfce4-session &
    fi
    
    # Launch terminal with fastfetch after XFCE starts
    sleep 3
    DISPLAY=:0 xfce4-terminal -e "bash -c 'fastfetch; exec bash'" &
}

# Function: Start Debian XFCE
start_debian_xfce() {
    # GPU detection and prompt FIRST
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    echo -e "${GREEN}[Debian XFCE]${NC} GPU Detected: $gpu_info" | tee -a ~/xfce_gpu.log
    
    # Step 1: Choose Termux graphics server
    echo "Step 1: Select Termux graphics server:"
    echo "  0) No GPU acceleration"
    echo "  1) ZINK server (Vulkan)"
    echo "  2) VIRGL server (OpenGL)"
    echo -n "Choice [0/1/2]: " > /dev/tty
    read -r server_choice < /dev/tty
    
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    
    # Start Termux X11 if not already running
    if ! pgrep -f "termux-x11" > /dev/null; then
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        # Setup audio (experimental: Samsung-specific fix, may work for other devices)
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    fi
    
    if [[ "$server_choice" == "1" ]]; then
        # ZINK server
        echo -e "${GREEN}[Debian XFCE]${NC} Starting ZINK server (Vulkan)" | tee -a ~/xfce_gpu.log
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 GALLIUM_DRIVER=zink ZINK_DESCRIPTORS=lazy virgl_test_server --use-egl-surfaceless --use-gles &
        sleep 2
        
        # Step 2: Choose proot driver
        echo ""
        echo "Step 2: Select proot driver:"
        echo "  1) ZINK (Vulkan via virpipe)"
        echo "  2) VIRGL (OpenGL via virpipe)"
        echo "  3) Turnip (Native Vulkan - Experimental)"
        echo -n "Choice [1/2/3]: " > /dev/tty
        read -r driver_choice < /dev/tty
        
        if [[ "$driver_choice" == "2" ]]; then
            echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL driver" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
        elif [[ "$driver_choice" == "3" ]]; then
            echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip driver (Experimental)" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform dbus-launch --exit-with-session xfce4-session
        else
            echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK driver" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
        fi
        
    elif [[ "$server_choice" == "2" ]]; then
        # VIRGL server
        echo -e "${GREEN}[Debian XFCE]${NC} Starting VIRGL server (OpenGL)" | tee -a ~/xfce_gpu.log
        if echo "$gpu_info" | grep -iq "mali"; then
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        else
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
        fi
        sleep 2
        
        # Step 2: Choose proot driver
        echo ""
        echo "Step 2: Select proot driver:"
        echo "  1) ZINK (Vulkan via virpipe)"
        echo "  2) VIRGL (OpenGL via virpipe)"
        echo "  3) Turnip (Native Vulkan - Experimental)"
        echo -n "Choice [1/2/3]: " > /dev/tty
        read -r driver_choice < /dev/tty
        
        if [[ "$driver_choice" == "2" ]]; then
            echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL driver" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
        elif [[ "$driver_choice" == "3" ]]; then
            echo -e "${YELLOW}[Debian XFCE]${NC} Using Turnip driver (Experimental)" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform dbus-launch --exit-with-session xfce4-session
        else
            echo -e "${GREEN}[Debian XFCE]${NC} Using ZINK driver" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=zink MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
        fi
        
    else
        # No GPU acceleration
        echo -e "${YELLOW}[Debian XFCE]${NC} Software rendering mode" | tee -a ~/xfce_gpu.log
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    fi
}

# Function: Enter Debian proot CLI
start_debian() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    export DISPLAY=:0
    proot-distro login debian --user $username --shared-tmp
}

# Function: Run Debian commands
drun() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 "$@"
}

# Function: Run with hardware acceleration
dgpu() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform "$@"
}

# Function: Run with hardware acceleration + FPS display
dfps() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform GALLIUM_HUD=fps "$@"
}

# Function: Kill Termux-X11
kill_termux_x11() {
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
}

# Function: Show interactive menu
show_menu() {
    while true; do
        clear
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian CLI"
        echo "      Enter Debian proot terminal"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - drun <command>"
        echo "      Run Debian commands from Termux"
        echo ""
        echo -e "  ${GREEN}5${NC} - dgpu <command>"
        echo "      Run with hardware acceleration"
        echo ""
        echo -e "  ${GREEN}6${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "${CYAN}Setup:${NC}"
        echo -e "  ${GREEN}9${NC} - Run Initializer"
        echo "      Download and run initialize script"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-9]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    drun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    dgpu $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            6)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            9)
                echo ""
                echo -e "${GREEN}Running initializer...${NC}"
                curl -sL https://raw.githubusercontent.com/Jessiebrig/termux_dual_xfce/main/initialize.sh | bash
                exit 0
                ;;
            0)
                echo ""
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

# Main logic
if [[ $# -eq 0 ]]; then
    # No arguments - show interactive menu
    show_menu
else
    # Arguments provided - run the function
    case "$1" in
        start_xfce|xfce)
            start_xfce
            ;;
        start_debian_xfce|debian_xfce)
            start_debian_xfce
            ;;
        start_debian|debian)
            start_debian
            ;;
        drun)
            shift
            drun "$@"
            ;;
        dgpu)
            shift
            dgpu "$@"
            ;;
        dfps)
            shift
            dfps "$@"
            ;;
        kill_termux_x11)
            kill_termux_x11
            ;;
        *)
            echo "Unknown command: $1"
            echo ""
            echo "Available commands:"
            echo "  xrun                  - Show interactive menu"
            echo "  xrun xfce             - Launch native Termux XFCE"
            echo "  xrun debian_xfce      - Launch Debian XFCE"
            echo "  xrun debian           - Enter Debian proot CLI"
            echo "  xrun drun <command>   - Run Debian commands"
            echo "  xrun dgpu <command>   - Run with hardware acceleration"
            echo "  xrun dfps <command>   - Run with HW accel + FPS display"
            echo "  xrun kill_termux_x11  - Kill Termux-X11"
            exit 1
            ;;
    esac
fi
