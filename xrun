#!/bin/bash

# Color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Function: Start native Termux XFCE
start_xfce() {
    kill -9 $(pgrep -f "termux.x11") 2>/dev/null

    # Setup audio (experimental: Samsung-specific fix, may work for other devices)
    if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
        LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    else
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    fi

    export PULSE_SERVER=127.0.0.1
    export XDG_RUNTIME_DIR=${TMPDIR}
    export DISPLAY=:0

    # Ensure D-Bus directories exist
    mkdir -p "$XDG_RUNTIME_DIR"

    termux-x11 :0 >/dev/null &
    sleep 3

    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    sleep 1

    # GPU detection and logging
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    echo -e "${GREEN}[Termux XFCE]${NC} GPU: $gpu_info" | tee -a ~/xfce_gpu.log
    if echo "$gpu_info" | grep -iq "adreno"; then
        echo -e "${GREEN}[Termux XFCE]${NC} Hardware acceleration: Enabled (Adreno)" | tee -a ~/xfce_gpu.log
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
    elif echo "$gpu_info" | grep -iq "mali"; then
        echo -e "${GREEN}[Termux XFCE]${NC} Hardware acceleration: Enabled (Mali)" | tee -a ~/xfce_gpu.log
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
    else
        echo -e "${YELLOW}[Termux XFCE]${NC} Hardware acceleration: Software rendering" | tee -a ~/xfce_gpu.log
    fi

    dbus-launch --exit-with-session env GALLIUM_DRIVER=virpipe xfce4-session &
}

# Function: Start Debian XFCE
start_debian_xfce() {
    # Start Termux X11 if not already running
    if ! pgrep -f "termux-x11" > /dev/null; then
        kill -9 $(pgrep -f "termux.x11") 2>/dev/null
        
        # Setup audio (experimental: Samsung-specific fix, may work for other devices)
        if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
            LD_PRELOAD=/system/lib64/libskcodec.so pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        else
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        fi
        
        export PULSE_SERVER=127.0.0.1
        export XDG_RUNTIME_DIR=${TMPDIR}
        mkdir -p "$XDG_RUNTIME_DIR"
        
        termux-x11 :0 >/dev/null &
        sleep 3
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
    fi

    # GPU detection and driver selection
    gpu_info="$(getprop ro.hardware.egl) $(getprop ro.hardware.vulkan)"
    echo -e "${GREEN}[Debian XFCE]${NC} GPU Detected: $gpu_info" | tee -a ~/xfce_gpu.log
    
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    
    # Detect GPU type and choose appropriate driver
    if echo "$gpu_info" | grep -iq "adreno"; then
        # Check if it's Adreno 6XX or 7XX
        adreno_version=$(echo "$gpu_info" | grep -oP 'Adreno.*?[67][0-9]{2}' | grep -oP '[67][0-9]{2}')
        if [[ -n "$adreno_version" ]]; then
            echo -e "${GREEN}[Debian XFCE]${NC} Using Turnip driver (Adreno $adreno_version)" | tee -a ~/xfce_gpu.log
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform dbus-launch --exit-with-session xfce4-session
        else
            echo -e "${YELLOW}[Debian XFCE]${NC} Adreno GPU detected but not 6XX/7XX series" | tee -a ~/xfce_gpu.log
            echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL driver" | tee -a ~/xfce_gpu.log
            MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android &
            sleep 2
            proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
        fi
    elif echo "$gpu_info" | grep -iq "mali"; then
        echo -e "${GREEN}[Debian XFCE]${NC} Using VIRGL driver (Mali GPU)" | tee -a ~/xfce_gpu.log
        MESA_NO_ERROR=1 MESA_GL_VERSION_OVERRIDE=4.3COMPAT MESA_GLES_VERSION_OVERRIDE=3.2 virgl_test_server_android --angle-gl &
        sleep 2
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 GALLIUM_DRIVER=virpipe MESA_GL_VERSION_OVERRIDE=4.0 dbus-launch --exit-with-session xfce4-session
    else
        echo -e "${YELLOW}[Debian XFCE]${NC} Unknown GPU, using software rendering" | tee -a ~/xfce_gpu.log
        proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 dbus-launch --exit-with-session xfce4-session
    fi
}

# Function: Enter Debian proot CLI
start_debian() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    export DISPLAY=:0
    proot-distro login debian --user $username --shared-tmp
}

# Function: Run Debian commands
drun() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 "$@"
}

# Function: Run with hardware acceleration
dgpu() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform "$@"
}

# Function: Run with hardware acceleration + FPS display
dfps() {
    username=$(basename $PREFIX/var/lib/proot-distro/installed-rootfs/debian/home/*)
    proot-distro login debian --user $username --shared-tmp -- env DISPLAY=:0 MESA_LOADER_DRIVER_OVERRIDE=zink TU_DEBUG=noconform GALLIUM_HUD=fps "$@"
}

# Function: Kill Termux-X11
kill_termux_x11() {
    am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
    pkill -f termux
}

# Function: Show interactive menu
show_menu() {
    while true; do
        clear
        echo ""
        echo "┌────────────────────────────────────────┐"
        echo "│       Termux XFCE Quick Launch         │"
        echo "└────────────────────────────────────────┘"
        echo ""
        echo -e "${CYAN}Desktop Environments:${NC}"
        echo -e "  ${GREEN}1${NC} - Start Native Termux XFCE"
        echo "      Launch XFCE desktop in Termux-X11"
        echo ""
        echo -e "  ${GREEN}2${NC} - Start Debian XFCE"
        echo "      Launch XFCE desktop in Debian proot"
        echo ""
        echo -e "  ${GREEN}3${NC} - Start Debian CLI"
        echo "      Enter Debian proot terminal"
        echo ""
        echo -e "${CYAN}Utilities:${NC}"
        echo -e "  ${GREEN}4${NC} - drun <command>"
        echo "      Run Debian commands from Termux"
        echo ""
        echo -e "  ${GREEN}5${NC} - dgpu <command>"
        echo "      Run with hardware acceleration"
        echo ""
        echo -e "  ${GREEN}6${NC} - Kill Termux-X11"
        echo "      Stop all X11 sessions"
        echo ""
        echo -e "${CYAN}Setup:${NC}"
        echo -e "  ${GREEN}7${NC} - Run Initializer"
        echo "      Download and run initialize script"
        echo ""
        echo -e "  ${YELLOW}0${NC} - Exit"
        echo ""
        echo -n "Select option [0-7]: " > /dev/tty
        read choice < /dev/tty
        
        case $choice in
            1)
                echo ""
                echo -e "${GREEN}Starting Native Termux XFCE...${NC}"
                start_xfce
                exit 0
                ;;
            2)
                echo ""
                echo -e "${GREEN}Starting Debian XFCE...${NC}"
                start_debian_xfce
                exit 0
                ;;
            3)
                echo ""
                echo -e "${GREEN}Entering Debian CLI...${NC}"
                start_debian
                exit 0
                ;;
            4)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    drun $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            5)
                echo ""
                echo -n "Enter command to run: " > /dev/tty
                read cmd < /dev/tty
                if [[ -n "$cmd" ]]; then
                    dgpu $cmd
                fi
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            6)
                echo ""
                echo -e "${YELLOW}Killing Termux-X11...${NC}"
                kill_termux_x11
                echo "Done."
                echo -n "Press Enter to continue..." > /dev/tty
                read < /dev/tty
                ;;
            7)
                echo ""
                echo -e "${GREEN}Running initializer...${NC}"
                curl -sL https://raw.githubusercontent.com/Jessiebrig/termux_dual_xfce/main/initialize.sh | bash
                exit 0
                ;;
            0)
                echo ""
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo ""
                echo -e "${YELLOW}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac
    done
}

# Main logic
if [[ $# -eq 0 ]]; then
    # No arguments - show interactive menu
    show_menu
else
    # Arguments provided - run the function
    case "$1" in
        start_xfce|xfce)
            start_xfce
            ;;
        start_debian_xfce|debian_xfce)
            start_debian_xfce
            ;;
        start_debian|debian)
            start_debian
            ;;
        drun)
            shift
            drun "$@"
            ;;
        dgpu)
            shift
            dgpu "$@"
            ;;
        dfps)
            shift
            dfps "$@"
            ;;
        kill_termux_x11)
            kill_termux_x11
            ;;
        *)
            echo "Unknown command: $1"
            echo ""
            echo "Available commands:"
            echo "  xrun                  - Show interactive menu"
            echo "  xrun xfce             - Launch native Termux XFCE"
            echo "  xrun debian_xfce      - Launch Debian XFCE"
            echo "  xrun debian           - Enter Debian proot CLI"
            echo "  xrun drun <command>   - Run Debian commands"
            echo "  xrun dgpu <command>   - Run with hardware acceleration"
            echo "  xrun dfps <command>   - Run with HW accel + FPS display"
            echo "  xrun kill_termux_x11  - Kill Termux-X11"
            exit 1
            ;;
    esac
fi
